name: Build and upload to PyPI

on:
  pull_request:
  release:
    types:
      - published

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14]

    steps:
      - uses: actions/checkout@v4

      - name: Test against oldest supported numpy version
        shell: bash
        run: |
            wget https://github.com/indygreg/python-build-standalone/releases/download/20240726/cpython-3.12.4+20240726-aarch64-apple-darwin-install_only_stripped.tar.gz
            tar -xcfv cpython-3.12.4+20240726-aarch64-apple-darwin-install_only_stripped.tar.gz
            ./python/bin/pip install nlsam pytest
            ./python/bin/pytest --pyargs nlsam --verbose
            tar -cfzv nlsam_mac_arm64.tar.gz ./python
                        
      - uses: actions/upload-artifact@v4
        with:
          name: cibw-nlsam_${{ matrix.os }}
          path: ./*.tar.gz
